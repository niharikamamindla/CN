#include <stdio.h>
#include <stdlib.h>

#define NOF_PACKETS 10

int rands(int a)
{
    int rn = (rand() % 10) * a;
    return rn == 0 ? 1 : rn;
}

int main()
{
    int packet_sz[NOF_PACKETS], i, clk, b_size, o_rate;
    int p_sz_rm = 0, p_sz, p_time, op, p_time_temp;

    // Generate random packet sizes
    for (i = 0; i < NOF_PACKETS; i++)
        packet_sz[i] = rands(6) * 10;

    printf("\nEnter the output rate: ");
    scanf("%d", &o_rate);

    printf("\nEnter the bucket size: ");
    scanf("%d", &b_size);

    for (i = 0; i < NOF_PACKETS; i++)
    {
        // Check if packet size exceeds bucket capacity
        if ((packet_sz[i] + p_sz_rm) > b_size)
        {
            if (packet_sz[i] > b_size)
                printf("\n\nIncoming packet size(%d bytes) is greater than bucket capacity(%d bytes)", packet_sz[i], b_size);
            else
                printf("\n\nBucket capacity exceeded - PACKET REJECTED");
        }
        else
        {
            p_sz_rm = packet_sz[i];

            printf("\n\nIncoming packet size: %d bytes", packet_sz[i]);
            printf("\nBytes remaining to transmit: %d", p_sz_rm);

            p_time = rands(4) * 10;
            printf("\nTime left for transmission: %d units", p_time);

            for (clk = 10; clk <= p_time; clk += 10)
                sleep(1);

            if (p_sz_rm)
            {
                if (p_sz_rm <= o_rate)
                {
                    printf("\nPacket of size %d transmitted", p_sz_rm);
                    p_sz_rm = 0;
                }
                else
                {
                    while (p_sz_rm > o_rate)
                    {
                        p_sz_rm -= o_rate;
                        printf("\nTransmitted %d bytes, remaining: %d", o_rate, p_sz_rm);
                        sleep(1);
                    }
                    if (p_sz_rm > 0)
                    {
                        printf("\nFinal %d bytes transmitted", p_sz_rm);
                        p_sz_rm = 0;
                    }
                }
            }
        }
    }

    return 0;
}